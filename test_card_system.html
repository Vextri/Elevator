<!DOCTYPE html>
<html>
<head>
    <title>Card Login Test</title>
</head>
<body>
    <h1>Card Login System Test</h1>
    
    <div id="status">Testing...</div>
    
    <script>
    async function testSystem() {
        const statusDiv = document.getElementById('status');
        let output = '';
        
        // Test 0: Clear any existing sessions first
        output += '<h3>Test 0: Session Cleanup</h3>';
        try {
            const clearResponse = await fetch('logout.php');
            output += `✅ Session cleared<br><br>`;
        } catch (error) {
            output += `⚠️ Session clear failed: ${error}<br><br>`;
        }
        
        // Test 1: Check AJAX endpoint
        output += '<h3>Test 1: AJAX Endpoint (should show no session)</h3>';
        try {
            const response = await fetch('check_card_login.php');
            const data = await response.json();
            output += `✅ AJAX endpoint working<br>`;
            output += `Status: ${data.status}<br>`;
            output += `Message: ${data.message}<br>`;
            
            if (data.status === 'not_logged_in') {
                output += `✅ Correct - no active session<br><br>`;
            } else {
                output += `⚠️ Warning - session still active after logout<br><br>`;
            }
        } catch (error) {
            output += `❌ AJAX endpoint failed: ${error}<br><br>`;
        }
        
        // Test 2: Try a test card login
        output += '<h3>Test 2: Test Card Login</h3>';
        try {
            const formData = new FormData();
            formData.append('student_card', 'UID: 04 5C 63 5A 7E 70 80');
            formData.append('action', 'card_login');
            
            const response = await fetch('card_login.php', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            output += `Login attempt result:<br>`;
            output += `Success: ${data.success}<br>`;
            output += `Message: ${data.message}<br><br>`;
            
            if (data.success) {
                // Test 3: Check if session is detected
                output += '<h3>Test 3: Session Detection</h3>';
                
                // Wait a moment for session to be created
                setTimeout(async () => {
                    try {
                        const sessionResponse = await fetch('check_card_login.php');
                        const sessionData = await sessionResponse.json();
                        output += `Session status: ${sessionData.status}<br>`;
                        output += `Session message: ${sessionData.message}<br>`;
                        
                        if (sessionData.status === 'logged_in') {
                            output += `✅ SUCCESS! Auto-redirect would work!<br>`;
                            output += `<a href="${sessionData.redirect_url || 'dashboard.php'}" target="_blank">Test Dashboard</a><br>`;
                        } else {
                            output += `❌ Session not detected. Check PHP session handling.<br>`;
                        }
                    } catch (error) {
                        output += `❌ Session check failed: ${error}<br>`;
                    }
                    statusDiv.innerHTML = output;
                }, 1000);
            }
        } catch (error) {
            output += `❌ Card login failed: ${error}<br><br>`;
        }
        
        statusDiv.innerHTML = output;
    }
    
    // Run test when page loads
    testSystem();
    </script>
</body>
</html>
